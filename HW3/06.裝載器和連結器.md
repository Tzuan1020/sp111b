# 第5章: 裝載器和連結器

## 5.1 裝載器的功能和流程
裝載器（Loader）是操作系統的一個重要組件，負責將執行檔（Executable File）或程式的目標機器碼載入到記憶體中，以便讓作業系統執行該程式。

### 1. 記憶體配置
裝載器首先需要確定並配置要為程式分配的記憶體空間。它會根據目標機器碼的大小和需求，找到可用的記憶體區域，並為程式分配足夠的空間。

### 2. 載入目標機器碼
一旦有足夠的記憶體空間，裝載器將讀取執行檔中的目標機器碼。這些目標機器碼是由編譯器或彙編器生成的，表示程式的指令和數據。

### 3. 重定位（Relocation）
在載入目標機器碼之前，裝載器需要處理重定位的問題。由於目標機器碼的生成可能是在編譯時或彙編時完成的，其中包含相對於記憶體位置的地址。裝載器將根據實際的記憶體位置，對目標機器碼進行地址修正，以便正確地將指令和數據載入到記憶體中。

### 4. 符號解析（Symbol Resolution）
當目標機器碼中包含外部函式或全域變數的引用時，裝載器需要解析這些符號，以便連接到正確的地址。這通常涉及符號表（Symbol Table）的查找和解析，以找到相應的符號定義。

### 5. 許可權和保護
裝載器還負責處理程式的許可權和保護機制。它會根據作業系統的安全機制，確保只有具有相應權限的使用者才能載入和執行程式，並保護記憶體的完整性和隔離性。

### 6. 控制轉移
最後，裝載器將控制權轉移到程式的入口點，使其可以開始執行。


## 5.2 裝載器的類型和特點
裝載器（Loader）根據其執行方式和所處的環境，可以分為不同的類型，每個類型都有其特點。

### 1. 絕對裝載器（Absolute Loader）
絕對裝載器將程式映像完全載入記憶體的指定位置，並在執行之前將所有引用解析和重定位。它適用於具有固定記憶體配置的環境，且不需要運行時重定位。

### 2. 可重定位裝載器（Relocatable Loader）
可重定位裝載器將程式映像載入記憶體，但在執行之前僅完成部分解析和重定位。它會將引用和地址保存在可重定位格式的程式映像中，以便在執行時根據實際的記憶體配置進行進一步解析和重定位。這種裝載器適用於可移植性要求較高的系統。

### 3. 共享裝載器（Shared Loader）
共享裝載器允許多個程式共享同一個程式庫或可執行檔。它將程式庫載入到記憶體中的共享區域，並在不同的程式之間共享該程式庫。這樣可以節省記憶體空間，提高效能，並簡化程式更新和維護。

### 4.延遲裝載器（Lazy Loader）
延遲裝載器僅在需要時才載入程式映像或資源。它將程式映像的載入推遲到第一次使用相關資源的時候，以減少啟動時間和記憶體使用。這種裝載器常用於大型應用程式或系統中，其中僅有部分功能被使用。

### 5. 在線裝載器（Online Loader）
在線裝載器允許在執行時從外部源（如網路）載入程式映像或資源。它可以實現動態下載和更新程式，並根據需求進行裝載和卸載。


## 5.3 連結器的作用和執行過程
連結器（Linker）是一種系統軟體，負責將多個編譯後的目標檔案（object files）合併為一個可執行的程式或庫文件。連結器的主要作用是解決符號引用、合併程式碼和資料段、生成可執行文件的結構，並處理底層的記憶體分配和地址重定位等任務。

連結器的執行過程可以簡要描述如下：

### 1. 符號解析（Symbol Resolution）
連結器首先解析目標檔案中的符號引用，包括函式呼叫和全域變數的引用。它會尋找符號的定義，可以是在其他目標檔案中或是外部函式庫中。

### 2. 符號解析與合併（Symbol Resolution and Merging）
連結器將解析的符號與對應的定義進行關聯，並將多個目標檔案中的程式碼段（code segments）和資料段（data segments）合併為一個整體。

### 3. 重定位（Relocation）
連結器處理地址重定位，將程式中的絕對地址轉換為相對於最終記憶體位置的相對地址。它會修正程式中的跳轉指令、變數引用等，以確保程式在正確的記憶體位置運行。

### 4. 庫文件處理（Library Handling）
如果程式使用了外部函式庫，連結器會從庫文件中提取所需的符號和程式碼，並將其合併到最終的可執行文件中。

### 5. 記憶體分配（Memory Allocation）
連結器負責將可執行文件分配到記憶體中的適當位置。它可能需要考慮記憶體的佈局和分段策略，以確保程式的順利執行。

### 6. 符號表更新（Symbol Table Update）
連結器更新符號表，記錄符號的最終定義和地址，以便在執行時進行適當的符號解析和重定位。

### 7. 生成可執行文件（Executable Generation）
最後，連結器將根據解析和重定位的結果，將所有物件檔案結合在一起，生成最終的可執行檔案或庫文件。這包括將程式映像連接在一起、設定執行環境等。